

{% load wagtailcore_tags %}

<div class="form-container bg-white shadow-lg rounded-lg p-6 my-4"
     x-data="{
        submitted: false,
        errorMessage: '',
        async submitForm(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            try {
                const response = await fetch('{% url 'form_submission' %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: formData
                });
                
                if (response.ok) {
                    this.submitted = true;
                    this.errorMessage = '';
                } else {
                    const data = await response.json();
                    this.errorMessage = data.error || 'Une erreur est survenue';
                }
            } catch (error) {
                this.errorMessage = 'Une erreur est survenue';
                console.error('Error:', error);
            }
        }
     }">
    
    <!-- Header -->
    <div class="mb-6">
        <h3 class="text-2xl font-bold mb-2">{{ self.form.title }}</h3>
        {% if self.form.description %}
            <div class="text-gray-600">{{ self.form.description|richtext }}</div>
        {% endif %}
    </div>

    <!-- Success Message -->
    <div x-show="submitted" 
         x-transition
         class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        {{ self.form.success_message }}
    </div>

    <!-- Error Message -->
    <div x-show="errorMessage"
         x-transition
         class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"
         x-text="errorMessage">
    </div>

    <!-- Form -->
    <form x-show="!submitted"
          @submit.prevent="submitForm"
          class="space-y-6">
        {% csrf_token %}
        <input type="hidden" name="form_id" value="{{ self.form.id }}">

        {% for field in self.form.fields.all %}
            <div class="field-wrapper">
                <label class="block text-gray-700 text-sm font-bold mb-2">
                    {{ field.label }}
                    {% if field.required %}*{% endif %}
                </label>

                {% if field.field_type == 'singleline' %}
                    <input type="text" 
                           name="{{ field.label|slugify }}"
                           class="w-full px-3 py-2 border rounded-lg"
                           {% if field.required %}required{% endif %}
                           {% if field.default_value %}value="{{ field.default_value }}"{% endif %}
                           placeholder="{{ field.help_text }}">

                {% elif field.field_type == 'multiline' %}
                    <textarea name="{{ field.label|slugify }}"
                              class="w-full px-3 py-2 border rounded-lg"
                              {% if field.required %}required{% endif %}
                              placeholder="{{ field.help_text }}"
                              rows="4">{{ field.default_value }}</textarea>

                {% elif field.field_type == 'email' %}
                    <input type="email"
                           name="{{ field.label|slugify }}"
                           class="w-full px-3 py-2 border rounded-lg"
                           {% if field.required %}required{% endif %}
                           {% if field.default_value %}value="{{ field.default_value }}"{% endif %}
                           placeholder="{{ field.help_text }}">

                {% elif field.field_type == 'checkbox' %}
                    <div class="flex items-center">
                        <input type="checkbox"
                               name="{{ field.label|slugify }}"
                               class="mr-2"
                               {% if field.required %}required{% endif %}
                               {% if field.default_value == "true" %}checked{% endif %}>
                        {% if field.help_text %}
                            <span class="text-sm text-gray-600">{{ field.help_text }}</span>
                        {% endif %}
                    </div>

                {% elif field.field_type == 'radio' or field.field_type == 'select' %}
                    {% with choices=field.choices|split:"," %}
                        {% if field.field_type == 'radio' %}
                            <div class="space-y-2">
                            {% for choice in choices %}
                                <div class="flex items-center">
                                    <input type="radio"
                                           name="{{ field.label|slugify }}"
                                           value="{{ choice|trim }}"
                                           class="mr-2"
                                           {% if field.required %}required{% endif %}
                                           {% if field.default_value == choice|trim %}checked{% endif %}>
                                    <label>{{ choice|trim }}</label>
                                </div>
                            {% endfor %}
                            </div>
                        {% else %}
                            <select name="{{ field.label|slugify }}"
                                    class="w-full px-3 py-2 border rounded-lg"
                                    {% if field.required %}required{% endif %}>
                                <option value="">SÃ©lectionnez...</option>
                                {% for choice in choices %}
                                    <option value="{{ choice|trim }}"
                                            {% if field.default_value == choice|trim %}selected{% endif %}>
                                        {{ choice|trim }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    {% endwith %}
                {% endif %}

                {% if field.help_text and field.field_type != 'checkbox' %}
                    <p class="mt-1 text-sm text-gray-600">{{ field.help_text }}</p>
                {% endif %}
            </div>
        {% endfor %}

        <div class="mt-6">
            <button type="submit" 
                    class="bg-secondary hover:bg-primary text-white font-bold py-2 px-4 rounded">
                {{ self.form.submit_text }}
            </button>
        </div>
    </form>
</div>